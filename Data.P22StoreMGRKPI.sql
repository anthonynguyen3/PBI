-- List of all stores + location data
-- Updated bc LOCATION table was flattened to add new location category = POD (LOC_TYPE_CODE = 'F')
	-- New Location Hierarchy = Operations > Region > Area > Pod > District > Store
SELECT 
	s.LOC_NUM AS STORE_NUMBER
	,CONCAT(FORMAT(s.LOC_NUM,'00000'),' - ',s.CITY,', ',s.ADDRESS_LINE_1,', ',s.[STATE]) AS Store
	,s.DISTRICT_NUMBER
	,CONCAT(s.DISTRICT_NAME, ' (', s.DISTRICT_NUMBER, ')' ) AS DISTRICT
	,s.POD_NUMBER
	,CONCAT(s.POD_NAME, ' (', s.POD_NUMBER, ')' ) AS POD
	,s.AREA_NUMBER
	,CONCAT(s.AREA_NAME, ' (', s.AREA_NUMBER, ')' ) AS AREA
	,s.REGION_NUMBER
	,CONCAT(s.REGION_NAME, ' (', s.REGION_NUMBER, ')' ) AS REGION
FROM i2_Data.dbo.LOCATION s
WHERE
	s.LOC_TYPE_CODE = 'S'
	AND s.PARENT_LOCATION_NUMBER <> 199
	;

-- Query is same as v2. Targeted specifically for Store MGRs.
	-- Start date = FY2024 (2023-09-01) 
	-- Filtered only for STORE Pattern Codes = PROFITECT_PATTERNS_BY_OWNER_GROUP table is not needed for star schema
SELECT 		
	o.OPP_ID
	,o.SUMMARY
	,o.OPP_STATUS
	,o.OPP_RESOLUTION
	,o.OPP_VALUE
	,SUBSTRING(o.PATTERN_NAME, 1, PATINDEX('% %',REPLACE(o.PATTERN_NAME,'CP - ',''))+LEN('CP - ')) PATTERN_CODE
--	,o.ETHICSPOINT_CASE_NUMBER AS NAVEXCaseNumber
	,CASE
		WHEN o.ETHICSPOINT_CASE_NUMBER IN ('(none)',' ','1','0') THEN NULL 
		WHEN o.ETHICSPOINT_CASE_NUMBER LIKE '%.%' THEN NULL
		WHEN LEN( o.ETHICSPOINT_CASE_NUMBER ) < 6 THEN NULL
			ELSE o.ETHICSPOINT_CASE_NUMBER
		END AS NAVEXCaseNumber
		
	,o.ASSIGNEE
	,o.EMP_NUMBER_ASSIGNEE
	,CASE
		WHEN o.EMP_NUMBER_OWNER LIKE '%MGR%' THEN CAST(RIGHT(o.EMP_NUMBER_OWNER, 5) AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '2627994' AND o.[OWNER] = 'Rick Gaitan' THEN '1509257'
		WHEN o.EMP_NUMBER_OWNER = '1543428' AND o.[OWNER] = 'Store Manager 05463' THEN CAST('5463' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '1808676' AND o.[OWNER] = 'Store Manager 03197' THEN CAST('3197' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '1991504' AND o.[OWNER] = 'Store Manager 13705' THEN CAST('12705' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '1634916' AND o.[OWNER] = 'Store Manager 15010' THEN CAST('15010' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '2925478' AND o.[OWNER] = 'Store Manager 17217' THEN CAST('17217' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '2923967' AND o.[OWNER] = 'Store Manager 17684' THEN CAST('17684' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = 'SteeringCommittee' THEN CAST('SteeringCommittee' AS nvarchar)
			ELSE o.EMP_NUMBER_OWNER
		END AS EMP_NUMBER_OWNER 
	,CASE
			WHEN o.[OWNER] LIKE '%store manager%' THEN CAST( RIGHT(o.[OWNER], 5) AS int )
			WHEN LEFT(o.OPPORTUNITY_ENTITY, 7) LIKE '% -%' THEN CAST( LEFT(o.OPPORTUNITY_ENTITY, 5) AS int )
			-- Below added when 2025.03 ZPA update resulted in Quotes '"' being added to OPPORTUNITY_ENTITY, captures Store Number from OPPORTUNITY_ENTITY
			WHEN o.OPPORTUNITY_ENTITY LIKE '"%' THEN CAST( SUBSTRING(o.OPPORTUNITY_ENTITY, 2, CHARINDEX(' -', o.OPPORTUNITY_ENTITY, 1) - 1) AS int )
		END AS Store_Number
	,o.OPPORTUNITY_ENTITY
	,o.[OWNER]
--	,o.LABELS
	,o.OPP_GENERATED_TIME AS CreatedDate 
	,MIN(o.LAST_MODIFIED) MIN_LAST_MODIFIED
	,o.DATE_INSERTED
FROM i2_data.dbo.PROFITECT_OPPORTUNITIES o

WHERE 
	o.OPP_STATUS NOT IN ('HISTORY','Deleted')
	AND o.SUMMARY NOT LIKE 'Welcome to%'
	AND o.DATE_INSERTED BETWEEN '2023-09-01 00:00:00.001' AND GETDATE() 
	AND o.OPP_GENERATED_TIME BETWEEN '2023-09-01 00:00:00.001' AND GETDATE() 
	AND o.EMP_NUMBER_ASSIGNEE NOT IN ('4118541','4118551','analyst@profitect.com','9999999','1959518','1432914','2634721','1950877','1440795','1445805','jim.hare'
		,'1224862','2982027','2251383','1224862','1222234','2488189','1224384','1223749','2013702','1062954','2223799','4043932','2246468','2860864','IITeam'
		,'1185165','4546396','4234682','1863183','1325015','4255465','4256323','1448552','4546413','4546391','4546246','4546399','2589783','4639125','4748046')
	AND o.EMP_NUMBER_OWNER NOT IN ('4116158','4459658','amanda.duguay@zebra.com','1223749','4546246','4546396','4118541','1325015','1863183') 
	AND o.ASSIGNEE NOT IN ('Zebra Analysts')
--	AND o.OPP_ID NOT IN ('2565116','2565168')	-- Not needed bc alert = APM
--	AND o.PATTERN_NAME NOT LIKE 'CP - 705%'		-- Not needed bc alert = APM
	AND SUBSTRING(o.PATTERN_NAME, 1, PATINDEX('% %',REPLACE(o.PATTERN_NAME,'CP - ',''))+LEN('CP - ')) 
		IN (
				SELECT pg.PATTERN_CODE
				FROM i2_data.dbo.PROFITECT_PATTERNS_BY_OWNER_GROUP pg
				WHERE
					pg.OWNER_GROUP = 'Store'
				)
		
GROUP BY 
	o.OPP_ID,o.SUMMARY,o.OPP_STATUS,o.OPP_RESOLUTION,o.OPP_VALUE,o.ASSIGNEE,o.PATTERN_NAME,o.OPPORTUNITY_ENTITY
	,o.EMP_NUMBER_ASSIGNEE,o.[OWNER],o.EMP_NUMBER_OWNER,o.DATE_INSERTED,o.OPP_GENERATED_TIME,o.ETHICSPOINT_CASE_NUMBER 

ORDER BY 
	o.OPP_ID 
	,CASE 
		WHEN o.OPP_STATUS = 'New' THEN 1 
		WHEN o.OPP_STATUS = 'In progress' THEN 2 
		WHEN o.OPP_STATUS LIKE 'Resolved - %' THEN 3 
			ELSE 9 
		END
	,MIN_LAST_MODIFIED
	; 

-- Query only reflects the most recent/latest alert action. Does not reflect the complete alert lifecycle. 
	-- Significantly reduces the number of rows + query run time
	-- Targeted specifically for Store MGRs.
	-- Start date = FY2024 (2023-09-01) 
	-- Filtered only for STORE Pattern Codes = PROFITECT_PATTERNS_BY_OWNER_GROUP table is not needed for star schema
	-- Using window functions will avoid any possible issues with duplicate records due to duplicate date values
SELECT 		
	o.OPP_ID
	,o.SUMMARY
	,o.OPP_STATUS
	,o.OPP_RESOLUTION
	,o.OPP_VALUE
	,SUBSTRING(o.PATTERN_NAME, 1, PATINDEX('% %',REPLACE(o.PATTERN_NAME,'CP - ',''))+LEN('CP - ')) PATTERN_CODE
	,CASE
		WHEN o.ETHICSPOINT_CASE_NUMBER IN ('(none)',' ','1','0') THEN NULL 
		WHEN o.ETHICSPOINT_CASE_NUMBER LIKE '%.%' THEN NULL
		WHEN LEN( o.ETHICSPOINT_CASE_NUMBER ) < 6 THEN NULL
			ELSE o.ETHICSPOINT_CASE_NUMBER
		END AS NAVEXCaseNumber
		
	,o.ASSIGNEE
	,o.EMP_NUMBER_ASSIGNEE
	,CASE
		WHEN o.EMP_NUMBER_OWNER LIKE '%MGR%' THEN CAST(RIGHT(o.EMP_NUMBER_OWNER, 5) AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '2627994' AND o.[OWNER] = 'Rick Gaitan' THEN '1509257'
		WHEN o.EMP_NUMBER_OWNER = '1543428' AND o.[OWNER] = 'Store Manager 05463' THEN CAST('5463' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '1808676' AND o.[OWNER] = 'Store Manager 03197' THEN CAST('3197' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '1991504' AND o.[OWNER] = 'Store Manager 13705' THEN CAST('12705' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '1634916' AND o.[OWNER] = 'Store Manager 15010' THEN CAST('15010' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '2925478' AND o.[OWNER] = 'Store Manager 17217' THEN CAST('17217' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = '2923967' AND o.[OWNER] = 'Store Manager 17684' THEN CAST('17684' AS nvarchar)
		WHEN o.EMP_NUMBER_OWNER = 'SteeringCommittee' THEN CAST('SteeringCommittee' AS nvarchar)
			ELSE o.EMP_NUMBER_OWNER
		END AS EMP_NUMBER_OWNER 
	,CASE
			WHEN o.[OWNER] LIKE '%store manager%' THEN CAST( RIGHT(o.[OWNER], 5) AS int )
			WHEN LEFT(o.OPPORTUNITY_ENTITY, 7) LIKE '% -%' THEN CAST( LEFT(o.OPPORTUNITY_ENTITY, 5) AS int )
			-- Below added when 2025.03 ZPA update resulted in Quotes '"' being added to OPPORTUNITY_ENTITY, captures Store Number from OPPORTUNITY_ENTITY
			WHEN o.OPPORTUNITY_ENTITY LIKE '"%' THEN CAST( SUBSTRING(o.OPPORTUNITY_ENTITY, 2, CHARINDEX(' -', o.OPPORTUNITY_ENTITY, 1) - 1) AS int )
		END AS Store_Number
	,o.OPPORTUNITY_ENTITY
	,o.[OWNER]
	,o.OPP_GENERATED_TIME AS CreatedDate 
--	,MIN(o.LAST_MODIFIED) MIN_LAST_MODIFIED
	,LAST_MODIFIED
	,o.DATE_INSERTED
FROM (
	SELECT 
		*
		,ROW_NUMBER() OVER( PARTITION BY OPP_ID ORDER BY LAST_MODIFIED DESC ) AS _rownumber
	FROM i2_data.dbo.PROFITECT_OPPORTUNITIES
	) AS o

WHERE 
	o._rownumber = 1
	AND o.OPP_STATUS NOT IN ('HISTORY','Deleted')
	AND o.SUMMARY NOT LIKE 'Welcome to%'
	AND o.DATE_INSERTED BETWEEN '2023-09-01 00:00:00.001' AND GETDATE() 
	AND o.OPP_GENERATED_TIME BETWEEN '2023-09-01 00:00:00.001' AND GETDATE() 
	AND o.EMP_NUMBER_ASSIGNEE NOT IN ('4118541','4118551','analyst@profitect.com','9999999','1959518','1432914','2634721','1950877','1440795','1445805','jim.hare'
		,'1224862','2982027','2251383','1224862','1222234','2488189','1224384','1223749','2013702','1062954','2223799','4043932','2246468','2860864','IITeam'
		,'1185165','4546396','4234682','1863183','1325015','4255465','4256323','1448552','4546413','4546391','4546246','4546399','2589783','4639125','4748046')
	AND o.EMP_NUMBER_OWNER NOT IN ('4116158','4459658','amanda.duguay@zebra.com','1223749','4546246','4546396','4118541','1325015','1863183') 
	AND o.ASSIGNEE NOT IN ('Zebra Analysts')
--	AND o.OPP_ID NOT IN ('2565116','2565168')	-- Not needed bc alert = APM
--	AND o.PATTERN_NAME NOT LIKE 'CP - 705%'		-- Not needed bc alert = APM
	AND SUBSTRING(o.PATTERN_NAME, 1, PATINDEX('% %',REPLACE(o.PATTERN_NAME,'CP - ',''))+LEN('CP - ')) 
		IN (
				SELECT pg.PATTERN_CODE
				FROM i2_data.dbo.PROFITECT_PATTERNS_BY_OWNER_GROUP pg
				WHERE
					pg.OWNER_GROUP = 'Store'
				)
		
GROUP BY 
	o.OPP_ID,o.SUMMARY,o.OPP_STATUS,o.OPP_RESOLUTION,o.OPP_VALUE,o.ASSIGNEE,o.PATTERN_NAME,o.OPPORTUNITY_ENTITY,LAST_MODIFIED
	,o.EMP_NUMBER_ASSIGNEE,o.[OWNER],o.EMP_NUMBER_OWNER,o.DATE_INSERTED,o.OPP_GENERATED_TIME,o.ETHICSPOINT_CASE_NUMBER 

ORDER BY 
	o.OPP_ID 
/*	,CASE 
		WHEN o.OPP_STATUS = 'New' THEN 1 
		WHEN o.OPP_STATUS = 'In progress' THEN 2 
		WHEN o.OPP_STATUS LIKE 'Resolved - %' THEN 3 
			ELSE 9 
		END
*/	,LAST_MODIFIED
	; 