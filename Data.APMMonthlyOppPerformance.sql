-- MAIN QUERY >> Mainly taken from Pattern Centric Query 
	-- >> Biggest difference is on line 24 - 29 (made it more efficient by getting rid of all the employee numbers and joining the employee table and filtering by compensation code)
SELECT
	o.OPP_ID
	,o.SUMMARY
	,o.OPP_STATUS
	,o.OPP_RESOLUTION
	,o.OPP_VALUE
	,SUBSTRING(o.PATTERN_NAME, 1, PATINDEX('% %',REPLACE(o.PATTERN_NAME,'CP - ',''))+LEN('CP - ')) PATTERN_CODE
	,o.ASSIGNEE
	,o.EMP_NUMBER_ASSIGNEE
	,o.EMP_NUMBER_OWNER
	,o.[OWNER]
	,o.LABELS
	,MIN(o.LAST_MODIFIED) MIN_LAST_MODIFIED
	,o.DATE_INSERTED
FROM i2_data.dbo.PROFITECT_OPPORTUNITIES o
LEFT OUTER JOIN i2_data.dbo.EISB_LP_FEED emp
	ON o.EMP_NUMBER_OWNER = emp.EMP_NUMBER
WHERE 
	o.OPP_STATUS NOT IN ('HISTORY','Deleted')
	AND o.SUMMARY NOT LIKE 'Welcome to%'
	AND o.DATE_INSERTED BETWEEN '2020-03-01 00:00:00.001' AND GETDATE() -- Tim confirmed 6.30.2021 that FQ2 2020 (Feb 2020) is not needed
	AND o.ASSIGNEE NOT IN ('Zebra Analysts','Jim Hare','analyst profitect','analyst profitect','Investigative Analytics')
	AND o.[OWNER] NOT LIKE '%store%' AND o.EMP_NUMBER_OWNER NOT LIKE '%mgr%' AND o.EMP_NUMBER_OWNER NOT LIKE '%duguay%' 
	AND o.EMP_NUMBER_ASSIGNEE NOT LIKE ('%???%') AND o.EMP_NUMBER_OWNER NOT LIKE ('%???%')
	AND o.EMP_NUMBER_OWNER NOT IN ('SteeringCommittee','IITeam','james.vickery@zebra.com') 
	AND emp.COMPENSATION_CODE NOT IN
		('12459','1454','1458','1476','1747','22805','23617','25210','25755','28557','27516','27519','27228'
		,'27231','27233','27354','27355','27363','27388','27430','27514','27664','28196','28437','28556','28558'
		,'28560','28562','28942','29035','29256','3902','40021','40316','40611','40659','40737','41095')
GROUP BY 
	o.OPP_ID,o.SUMMARY,o.OPP_STATUS,o.OPP_RESOLUTION,o.OPP_VALUE,o.ASSIGNEE,
	o.EMP_NUMBER_ASSIGNEE,o.[OWNER],o.EMP_NUMBER_OWNER,o.LABELS,o.DATE_INSERTED,o.PATTERN_NAME
ORDER BY 
	o.OPP_ID
	,CASE 
		WHEN o.OPP_STATUS = 'New' THEN 1 
		WHEN o.OPP_STATUS = 'In progress' THEN 2 
		WHEN o.OPP_STATUS LIKE 'Resolved - %' THEN 3 
		ELSE 9 
	END
	,MIN_LAST_MODIFIED
	;

-- Employee table = Dim Table
SELECT 
	emp.EMP_NUMBER
	,emp.FIRST_NAME
	,ISNULL(emp.MIDDLE_INITIAL,'') AS MIDDLE_INITIAL
	,emp.LAST_NAME
	,CONCAT( emp.EMP_NUMBER, ' ',emp.FIRST_NAME,' ',emp.LAST_NAME ) AS Full_Employee
	,emp.JOB_TITLE
	,CASE 
		WHEN emp.COMPENSATION_CODE = '29046' THEN 'APM'
		WHEN emp.COMPENSATION_CODE = '29253' THEN 'APM'
		ELSE 'DM'
	END AS POSITION
FROM i2_data.dbo.EISB_LP_FEED emp
WHERE 
	emp.COMPENSATION_CODE IN ('29046','29253','27420','27421','27422','27424','29358');


-- Data Refresh Date/Time
SELECT MAX(DATE_INSERTED) date_refreshed
FROM (
	SELECT
		OPP_ID
		,SUMMARY
		,OPP_STATUS
		,OPP_RESOLUTION
		,OPP_VALUE
		,SUBSTRING(PATTERN_NAME, 1, PATINDEX('% %',REPLACE(PATTERN_NAME,'CP - ',''))+LEN('CP - ')) PATTERN_CODE
		,ASSIGNEE
		,EMP_NUMBER_ASSIGNEE
		,EMP_NUMBER_OWNER
		,[OWNER]
		,LABELS
		,MIN(LAST_MODIFIED) MIN_LAST_MODIFIED
		,DATE_INSERTED
	FROM i2_data.dbo.PROFITECT_OPPORTUNITIES o
	WHERE 
		OPP_STATUS NOT IN ('HISTORY','Deleted')
		AND SUMMARY NOT LIKE 'Welcome to%'
		AND DATE_INSERTED BETWEEN '2020-03-01 00:00:00.001' AND GETDATE() -- Tim confirmed 6.30.2021 that FQ2 2020 (Feb 2020) is not needed
		AND ASSIGNEE NOT IN ('Molly Pollard','Alex Beizerov','analyst profitect','APS Technology','BRETT CAMPBELL','BRIAN ITTNER'
		,'DEREK LANNI','GARY MONAGHAN','Alison Harmon','BILL INZEO','Jim Hare','Investigative Analytics','JACK DONOVAL','JAMES SPENCER','JEFF TOLVA'
		,'JOHN DONOVAL','KIMBERLY GANDY','LAUREN NESTOR','MELISSA VAN DE CARR','RAYMOND NOVAK','RAYMOND STUKEL','SCOTT JONKMAN','RACHEL KAMENIR'
		,'RAY NOVAK','SETH HUGHES','STEPHEN LAMALFA','Zebra Analysts','TAL HAREL')
		AND [OWNER] NOT LIKE '%NOVAK%' AND ASSIGNEE NOT LIKE '%KEN O''CONNOR%' AND ASSIGNEE NOT LIKE '%KENNETH O''CONNOR%' 
		AND EMP_NUMBER_OWNER NOT LIKE '%mgr%' AND EMP_NUMBER_OWNER NOT LIKE '%duguay%' AND EMP_NUMBER_OWNER NOT IN ('SteeringCommittee','IITeam') AND [OWNER] NOT LIKE '%store%'
		AND EMP_NUMBER_OWNER NOT IN ('1000168','1000526','1000648','1003532','1004436','1008230','1008328','1008678','1013525','1013739','1014319','1014443','1014768','1016343'
		,'1017452','1017895','1019461','1022760','1028276','1028359','1028628','1028683','1028736','1029603','1030108','1032716','1034406','1036861','1037226','1039184','1039871'
		,'1042473','1044513','1047811','1049564','1049796','1051391','1051692','1053640','1054780','1058344','1060006','1063940','1073125','1079105','1081589','1085171','1089244'
		,'1092340','1092650','1093726','1096142','1097831','1098356','1098790','1099014','1099454','1100519','1103069','1104118','1104161','1107580','1108476','1109178','1111429'
		,'1113443','1114743','1115838','1116434','1117649','1118164','1118997','1119061','1119764','1122729','1127042','1128796','1129083','1129376','1130251','1134635','1134948'
		,'1135155','1135406','1135411','1136269','1136292','1137038','1137628','1139015','1139291','1139324','1140220','1140744','1140999','1141057','1141703','1142261','1143147'
		,'1143578','1144804','1145210','1145747','1148484','1151547','1152507','1157916','1159968','1162779','1166988','1169004','1184287','1185160','1187472','1197657','1201934'
		,'1236309','1241029','1245178','1246328','1252941','1272409','1276085','1279756','1286008','1295929','1298416','1299063','1299672','1314593','1316459','1320600','1326476'
		,'1329242','1335543','1336312','1339904','1344031','1344808','1345182','1345336','1348044','1351007','1362551','1363117','1363135','1367260','1374548','1377488','1386022'
		,'1393740','1401480','1410089','1423663','1426845','1432528','1439325','1451556','1454873','1468468','1469781','1493052','1495950','1497929','1503210','1536784','1538509'
		,'1549351','1556528','1575030','1589118','1610940','1612743','1615011','1616483','1621371','1621624','1634916','1651865','1663226','1664585','1666940','1670662','1672414'
		,'1683090','1694728','1695821','1702727','1707576','1713421','1718012','1739982','1755147','1770786','1779427','1780730','1781909','1785708','1786680','1808676','1813241'
		,'1814673','1815897','1831139','1836629','1850236','1863641','1873787','1874355','1874507','1874627','1874720','1874728','1874785','1874929','1875073','1954279','1955152'
		,'1960343','1970509','1971003','1984054','1991504','2013702','2063229','2090100','2249950','2271127','2298690','2317837','2346224','2363311','2378255','2378955','2383302'
		,'2513636','2544905','2633581','2660543','2712877','2860864','2860868','2884768','2889265','2901323','2901334','2921718','2923967','2924164','2924194','2924708','2925478'
		,'2925558','2930426','2932721','2934392','2935601','2937537','2939644','2942966','2943735','2943744','2943796','2945532','2946026','2948788','2948794','2948833','2950026'
		,'2951258','2951434','2951548','2951731','2951893','2972166','3003594','3056960','3075596','4054555','4057084','4116158','4118541','4223146','4245904')
	GROUP BY 
		OPP_ID,SUMMARY,OPP_STATUS,OPP_RESOLUTION,OPP_VALUE,ASSIGNEE,
		EMP_NUMBER_ASSIGNEE,[OWNER],EMP_NUMBER_OWNER,LABELS,DATE_INSERTED,PATTERN_NAME
/*	ORDER BY 
		OPP_ID
		,CASE 
			WHEN OPP_STATUS = 'New' THEN 1 
			WHEN OPP_STATUS = 'In progress' THEN 2 
			WHEN OPP_STATUS LIKE 'Resolved - %' THEN 3 
			ELSE 9 
		END
		,MIN_LAST_MODIFIED;
*/
) test

/*
-- Updated with above query by getting rid of all the employee numbers and joining the employee table and filtering out the compensation codes
--	(lines 27-43 bc the EMP_NUMBER_OWNER does not = APM or DM > only looking for APM or DM)
SELECT
	OPP_ID
	,SUMMARY
	,OPP_STATUS
	,OPP_RESOLUTION
	,OPP_VALUE
	,SUBSTRING(PATTERN_NAME, 1, PATINDEX('% %',REPLACE(PATTERN_NAME,'CP - ',''))+LEN('CP - ')) PATTERN_CODE
	,ASSIGNEE
	,EMP_NUMBER_ASSIGNEE
	,EMP_NUMBER_OWNER
	,[OWNER]
	,LABELS
	,MIN(LAST_MODIFIED) MIN_LAST_MODIFIED
	,DATE_INSERTED
FROM i2_data.dbo.PROFITECT_OPPORTUNITIES o
WHERE 
	OPP_STATUS NOT IN ('HISTORY','Deleted')
	AND SUMMARY NOT LIKE 'Welcome to%'
	AND DATE_INSERTED BETWEEN '2020-03-01 00:00:00.001' AND GETDATE() -- Tim confirmed 6.30.2021 that FQ2 2020 (Feb 2020) is not needed
	AND ASSIGNEE NOT IN ('Molly Pollard','Alex Beizerov','analyst profitect','APS Technology','BRETT CAMPBELL','BRIAN ITTNER'
	,'DEREK LANNI','GARY MONAGHAN','Alison Harmon','BILL INZEO','Jim Hare','Investigative Analytics','JACK DONOVAL','JAMES SPENCER','JEFF TOLVA'
	,'JOHN DONOVAL','KIMBERLY GANDY','LAUREN NESTOR','MELISSA VAN DE CARR','RAYMOND NOVAK','RAYMOND STUKEL','SCOTT JONKMAN','RACHEL KAMENIR'
	,'RAY NOVAK','SETH HUGHES','STEPHEN LAMALFA','Zebra Analysts','TAL HAREL')
	AND [OWNER] NOT LIKE '%NOVAK%' AND ASSIGNEE NOT LIKE '%KEN O''CONNOR%' AND ASSIGNEE NOT LIKE '%KENNETH O''CONNOR%' 
	AND EMP_NUMBER_OWNER NOT LIKE '%mgr%' AND EMP_NUMBER_OWNER NOT LIKE '%duguay%' AND EMP_NUMBER_OWNER NOT IN ('SteeringCommittee','IITeam') AND [OWNER] NOT LIKE '%store%'
	AND EMP_NUMBER_OWNER NOT IN ('1000168','1000526','1000648','1003532','1004436','1008230','1008328','1008678','1013525','1013739','1014319','1014443','1014768','1016343'
	,'1017452','1017895','1019461','1022760','1028276','1028359','1028628','1028683','1028736','1029603','1030108','1032716','1034406','1036861','1037226','1039184','1039871'
	,'1042473','1044513','1047811','1049564','1049796','1051391','1051692','1053640','1054780','1058344','1060006','1063940','1073125','1079105','1081589','1085171','1089244'
	,'1092340','1092650','1093726','1096142','1097831','1098356','1098790','1099014','1099454','1100519','1103069','1104118','1104161','1107580','1108476','1109178','1111429'
	,'1113443','1114743','1115838','1116434','1117649','1118164','1118997','1119061','1119764','1122729','1127042','1128796','1129083','1129376','1130251','1134635','1134948'
	,'1135155','1135406','1135411','1136269','1136292','1137038','1137628','1139015','1139291','1139324','1140220','1140744','1140999','1141057','1141703','1142261','1143147'
	,'1143578','1144804','1145210','1145747','1148484','1151547','1152507','1157916','1159968','1162779','1166988','1169004','1184287','1185160','1187472','1197657','1201934'
	,'1236309','1241029','1245178','1246328','1252941','1272409','1276085','1279756','1286008','1295929','1298416','1299063','1299672','1314593','1316459','1320600','1326476'
	,'1329242','1335543','1336312','1339904','1344031','1344808','1345182','1345336','1348044','1351007','1362551','1363117','1363135','1367260','1374548','1377488','1386022'
	,'1393740','1401480','1410089','1423663','1426845','1432528','1439325','1451556','1454873','1468468','1469781','1493052','1495950','1497929','1503210','1536784','1538509'
	,'1549351','1556528','1575030','1589118','1610940','1612743','1615011','1616483','1621371','1621624','1634916','1651865','1663226','1664585','1666940','1670662','1672414'
	,'1683090','1694728','1695821','1702727','1707576','1713421','1718012','1739982','1755147','1770786','1779427','1780730','1781909','1785708','1786680','1808676','1813241'
	,'1814673','1815897','1831139','1836629','1850236','1863641','1873787','1874355','1874507','1874627','1874720','1874728','1874785','1874929','1875073','1954279','1955152'
	,'1960343','1970509','1971003','1984054','1991504','2013702','2063229','2090100','2249950','2271127','2298690','2317837','2346224','2363311','2378255','2378955','2383302'
	,'2513636','2544905','2633581','2660543','2712877','2860864','2860868','2884768','2889265','2901323','2901334','2921718','2923967','2924164','2924194','2924708','2925478'
	,'2925558','2930426','2932721','2934392','2935601','2937537','2939644','2942966','2943735','2943744','2943796','2945532','2946026','2948788','2948794','2948833','2950026'
	,'2951258','2951434','2951548','2951731','2951893','2972166','3003594','3056960','3075596','4054555','4057084','4116158','4118541','4223146','4245904')
GROUP BY 
	OPP_ID,SUMMARY,OPP_STATUS,OPP_RESOLUTION,OPP_VALUE,ASSIGNEE,
	EMP_NUMBER_ASSIGNEE,[OWNER],EMP_NUMBER_OWNER,LABELS,DATE_INSERTED,PATTERN_NAME
ORDER BY 
	OPP_ID
	,CASE 
		WHEN OPP_STATUS = 'New' THEN 1 
		WHEN OPP_STATUS = 'In progress' THEN 2 
		WHEN OPP_STATUS LIKE 'Resolved - %' THEN 3 
		ELSE 9 
	END
	,MIN_LAST_MODIFIED;

-- MAIN QUERY >> Mainly taken from Pattern Centric Query >> Biggest difference is on line 26 
	>> REPLACED WITH QUERY ABOVE BC THIS QUERY HAD EMP_NUMBER_OWNER THAT WERE NOT APM OR DMs. ABOVE QuerY ONLY HAS APM / DMs
SELECT
	OPP_ID
	,SUMMARY
	,OPP_STATUS
	,OPP_RESOLUTION
	,OPP_VALUE
	,SUBSTRING(PATTERN_NAME, 1, PATINDEX('% %',REPLACE(PATTERN_NAME,'CP - ',''))+LEN('CP - ')) PATTERN_CODE
	,ASSIGNEE
	,EMP_NUMBER_ASSIGNEE
	,EMP_NUMBER_OWNER
	,[OWNER]
	,LABELS
	,MIN(LAST_MODIFIED) MIN_LAST_MODIFIED
	,DATE_INSERTED
FROM i2_data.dbo.PROFITECT_OPPORTUNITIES o
WHERE 
	OPP_STATUS NOT IN ('HISTORY','Deleted')
	AND SUMMARY NOT LIKE 'Welcome to%'
	AND DATE_INSERTED BETWEEN '2020-03-01 00:00:00.001' AND GETDATE() -- Tim confirmed 6.30.2021 that FQ2 2020 (Feb 2020) is not needed
	AND ASSIGNEE NOT IN ('Molly Pollard','Alex Beizerov','analyst profitect','APS Technology','BRETT CAMPBELL','BRIAN ITTNER'
	,'DEREK LANNI','GARY MONAGHAN','Alison Harmon','BILL INZEO','Jim Hare','Investigative Analytics','JACK DONOVAL','JAMES SPENCER','JEFF TOLVA'
	,'JOHN DONOVAL','KIMBERLY GANDY','LAUREN NESTOR','MELISSA VAN DE CARR','RAYMOND NOVAK','RAYMOND STUKEL','SCOTT JONKMAN','RACHEL KAMENIR'
	,'RAY NOVAK','SETH HUGHES','STEPHEN LAMALFA','Zebra Analysts','TAL HAREL')
	AND [OWNER] NOT LIKE '%NOVAK%' AND ASSIGNEE NOT LIKE '%KEN O''CONNOR%' AND ASSIGNEE NOT LIKE '%KENNETH O''CONNOR%' 
	AND EMP_NUMBER_OWNER NOT LIKE '%mgr%' AND EMP_NUMBER_OWNER NOT LIKE '%duguay%' AND EMP_NUMBER_OWNER NOT IN ('SteeringCommittee','IITeam') AND [OWNER] NOT LIKE '%store%'
GROUP BY 
	OPP_ID,SUMMARY,OPP_STATUS,OPP_RESOLUTION,OPP_VALUE,ASSIGNEE,
	EMP_NUMBER_ASSIGNEE,[OWNER],EMP_NUMBER_OWNER,LABELS,DATE_INSERTED,PATTERN_NAME
ORDER BY 
	OPP_ID
	,CASE 
		WHEN OPP_STATUS = 'New' THEN 1 
		WHEN OPP_STATUS = 'In progress' THEN 2 
		WHEN OPP_STATUS LIKE 'Resolved - %' THEN 3 
		ELSE 9 
	END
	,MIN_LAST_MODIFIED;

-- MAIN QUERY = Fact table >> Star Schema w/Employee table = Dim Table >>> REPLACED WITH QUERY ABOVE BC REMOVED JOINED EMPLOYEE TABLE
SELECT 
	OPP_ID
	,SUMMARY
	,OPP_STATUS
	,OPP_RESOLUTION
	,OPP_VALUE
	,SUBSTRING(PATTERN_NAME, 1, PATINDEX('% %',REPLACE(PATTERN_NAME,'CP - ',''))+LEN('CP - ')) PATTERN_CODE
	,ASSIGNEE
	,EMP_NUMBER_ASSIGNEE
	,EMP_NUMBER_OWNER
	,[OWNER]
	,CASE 
		WHEN emp.COMPENSATION_CODE = '29046' THEN 'APM'
		WHEN emp.COMPENSATION_CODE = '29253' THEN 'APM'
		ELSE 'DM'
	END AS POSITION
	,LABELS
	,MIN(LAST_MODIFIED) MIN_LAST_MODIFIED
	,DATE_INSERTED
FROM i2_data.dbo.PROFITECT_OPPORTUNITIES o
LEFT OUTER JOIN i2_data.dbo.EISB_LP_FEED emp
	ON emp.EMP_NUMBER = o.EMP_NUMBER_OWNER
WHERE 
	OPP_STATUS NOT IN ('HISTORY','Deleted')
	AND SUMMARY NOT LIKE 'Welcome to%'
	AND DATE_INSERTED BETWEEN '2020-03-01 00:00:00.001' AND GETDATE() -- Tim confirmed 6.30.2021 that FQ2 2020 (Feb 2020) is not needed
	AND ASSIGNEE NOT IN ('Molly Pollard','Alex Beizerov','analyst profitect','APS Technology','BRETT CAMPBELL','BRIAN ITTNER'
	,'DEREK LANNI','GARY MONAGHAN','Alison Harmon','BILL INZEO','Jim Hare','Investigative Analytics','JACK DONOVAL','JAMES SPENCER','JEFF TOLVA'
	,'JOHN DONOVAL','KIMBERLY GANDY','LAUREN NESTOR','MELISSA VAN DE CARR','RAYMOND NOVAK','RAYMOND STUKEL','SCOTT JONKMAN','RACHEL KAMENIR'
	,'RAY NOVAK','SETH HUGHES','STEPHEN LAMALFA','Zebra Analysts','TAL HAREL')
	AND [OWNER] NOT LIKE '%NOVAK%' AND ASSIGNEE NOT LIKE '%KEN O''CONNOR%' AND ASSIGNEE NOT LIKE '%KENNETH O''CONNOR%' 
	AND EMP_NUMBER_OWNER NOT LIKE '%mgr%' AND EMP_NUMBER_OWNER NOT LIKE '%duguay%' AND EMP_NUMBER_OWNER NOT IN ('SteeringCommittee','IITeam') 
	AND emp.COMPENSATION_CODE IN ('29046','29253','27420','27421','27422','27424','29358')
--	AND OWNER LIKE '%store manager%'
GROUP BY 
	OPP_ID,SUMMARY,OPP_STATUS,OPP_RESOLUTION,OPP_VALUE,ASSIGNEE,EMP_NUMBER_ASSIGNEE,[OWNER],EMP_NUMBER_OWNER,LABELS,DATE_INSERTED,PATTERN_NAME,emp.COMPENSATION_CODE
ORDER BY OPP_ID 
	,CASE 
		WHEN OPP_STATUS = 'New' THEN 1 
		WHEN OPP_STATUS = 'In progress' THEN 2 
		WHEN OPP_STATUS LIKE 'Resolved - %' THEN 3 
		ELSE 9 
	END
	,MIN_LAST_MODIFIED;

*/